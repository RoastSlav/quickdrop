# QuickDrop AI Working Guide (concise)

- **Build/run**: Java 21. `./mvnw clean package` then `java -jar target/quickdrop.jar`. SQLite DB at `db/quickdrop.db`; Flyway baseline-on-migrate. Docker image `roastslav/quickdrop:latest` exposes 8080.
- **App shape**: Spring Boot MVC + Thymeleaf. Controllers in [src/main/java/org/rostislav/quickdrop/controller](src/main/java/org/rostislav/quickdrop/controller); services in [service](src/main/java/org/rostislav/quickdrop/service); interceptors in [interceptor](src/main/java/org/rostislav/quickdrop/interceptor); entities/repos in [entity](src/main/java/org/rostislav/quickdrop/entity) and [repository](src/main/java/org/rostislav/quickdrop/repository); static assets + templates under `src/main/resources/static` and `.../templates`.
- **Settings source of truth**: Single-row settings (id=1) via [ApplicationSettingsService](src/main/java/org/rostislav/quickdrop/service/ApplicationSettingsService.java). Defaults seed once (max size 1GB, life 30d, storage `files`/`logs`, cron `0 0 2 * * *`, app password off, admin password empty, file list & admin button enabled, encryption on, default home upload). Always reuse that row—never create extras.
- **Cleanup/scheduling**: [ScheduleService](src/main/java/org/rostislav/quickdrop/service/ScheduleService.java) handles expired files (cron + max life), missing-file cleanup, and share-token cleanup. Startup must call `updateSchedule` so deletion is actually scheduled; keep the cron non-null and log lines “Deleting old files …” to confirm runs.
- **Security**: [SecurityConfig](src/main/java/org/rostislav/quickdrop/config/SecurityConfig.java) enables whole-app password mode (`/password/login`), BCrypt, CSRF cookie, permissive CORS. Session timeout in [WebConfig](src/main/java/org/rostislav/quickdrop/config/WebConfig.java). Admin/file tokens kept in-memory via [SessionService](src/main/java/org/rostislav/quickdrop/service/SessionService.java).
- **Interceptors**: [AdminPasswordSetupInterceptor](src/main/java/org/rostislav/quickdrop/interceptor/AdminPasswordSetupInterceptor.java) forces `/admin/setup` until admin password exists. [AdminPasswordInterceptor](src/main/java/org/rostislav/quickdrop/interceptor/AdminPasswordInterceptor.java) gates `/admin/**` and file history. [FilePasswordInterceptor](src/main/java/org/rostislav/quickdrop/interceptor/FilePasswordInterceptor.java) redirects to `/file/password/{uuid}` when missing a valid file session token.
- **Upload pipeline**: `/api/file/upload-chunk` accepts chunked uploads with metadata (`description`, `keepIndefinitely`, `password`, `hidden`, `fileSize`, folder fields). [AsyncFileMergeService](src/main/java/org/rostislav/quickdrop/service/AsyncFileMergeService.java) buffers/merges; [FileEncryptionService](src/main/java/org/rostislav/quickdrop/service/FileEncryptionService.java) encrypts when password + encryption enabled; [FileService](src/main/java/org/rostislav/quickdrop/service/FileService.java) persists + logs. Chunk calls can return null—frontends must handle.
- **Metadata stripping (client-side)**: Registry in `static/js/metadata.js`; handles PDF, OOXML (DOCX/PPTX/XLSX), ODF (ODT/ODS/ODP), EPUB, SVG, JPEG/PNG/WebP, text-ish. UI pulls supported types via `data-supported-metadata` spans (upload/settings). 25 MB guard; failures prompt Confirm/Cancel.
- **Storage/model**: Files stored on disk under `fileStoragePath` with UUID filenames; metadata in `file_entity` (description, keepIndefinitely, hidden, optional password hash, encrypted flag, folder fields). [QuickdropApplication](src/main/java/org/rostislav/quickdrop/QuickdropApplication.java) ensures `./db` and storage path exist.
- **Downloads & share tokens**: `/file/download/{uuid}` decrypts on the fly; logs UPLOAD/RENEWAL/DOWNLOAD with IP/UA in `file_history_log`. Share links via `/api/file/share/{uuid}` and `/api/file/download/{uuid}/{token}`; tokens track remaining downloads and expire by date, cleaned in scheduler.
- **Caching/pagination**: Cache keys `publicFiles`, `adminFiles`, `analytics` (see [CacheConfig](src/main/java/org/rostislav/quickdrop/config/CacheConfig.java)). File lists and admin dashboard use Page-based queries with `page/size/query` propagation; mutate operations must evict caches (handled in `FileService`).
- **Admin UX**: Dashboard lists files with download counts and actions (view, history, download, delete, keep indefinitely toggle, hidden toggle) plus analytics (totals, space, avg size). Public list/admin dashboard paginated + searchable. Keep “keep indefinitely” and “hide” admin-only flags in settings respected.
- **Thymeleaf flags**: [GlobalControllerAdvice](src/main/java/org/rostislav/quickdrop/config/GlobalControllerAdvice.java) injects booleans for templates (file list enabled, app password set, admin button enabled, encryption enabled).
- **Front-end bits**: Tailwind CSS + custom JS. Share panel (fileView.html + static/js/fileView.js) generates tokens, copies links, and draws QR; QR canvas hidden until link exists. Upload flow modularized under `static/js` (controller/state/pipeline/network/zip/metadata).
- **Dev tips**: SQLite dialect configured; migrations under `src/main/resources/db/migration`. Few automated tests; typical check is `./mvnw clean package`. Logs at `log/quickdrop.log`. Default port 8080. Keep decrypted temp files (`*-decrypted`) in sync with share/deletion flows.
