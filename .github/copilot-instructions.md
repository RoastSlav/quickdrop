# QuickDrop AI Working Guide

- **Build & run**: Java 21; use `./mvnw clean package` then `java -jar target/quickdrop.jar`. SQLite DB lives at `db/quickdrop.db`; Flyway runs on startup with baseline-on-migrate. Docker image `roastslav/quickdrop:latest` exposes 8080.
- **App shape**: Spring Boot MVC + Thymeleaf views; controllers in [src/main/java/org/rostislav/quickdrop/controller](src/main/java/org/rostislav/quickdrop/controller), services in [service](src/main/java/org/rostislav/quickdrop/service), interceptors in [interceptor](src/main/java/org/rostislav/quickdrop/interceptor), entities/repos under [entity](src/main/java/org/rostislav/quickdrop/entity) and [repository](src/main/java/org/rostislav/quickdrop/repository). Static assets and templates live under `src/main/resources/static` and `.../templates`.
- **Settings source of truth**: Single-row settings (id=1) managed by [ApplicationSettingsService](src/main/java/org/rostislav/quickdrop/service/ApplicationSettingsService.java) and stored via JPA. Startup seeds defaults (max size 1GB, life 30d, paths `files`/`logs`, cron `0 0 2 * * *`, app password off, admin password empty, file list & admin button enabled, encryption on, default home upload) and schedules cleanup.
- **Security model**: If the app password is enabled, [SecurityConfig](src/main/java/org/rostislav/quickdrop/config/SecurityConfig.java) locks everything behind `/password/login` using BCrypt auth; CSRF cookie enabled; permissive CORS. Session timeout set from settings in [WebConfig](src/main/java/org/rostislav/quickdrop/config/WebConfig.java).
- **Interceptors**: [AdminPasswordSetupInterceptor](src/main/java/org/rostislav/quickdrop/interceptor/AdminPasswordSetupInterceptor.java) forces `/admin/setup` until admin password exists. [AdminPasswordInterceptor](src/main/java/org/rostislav/quickdrop/interceptor/AdminPasswordInterceptor.java) requires an admin session token for `/admin/**` and file history. [FilePasswordInterceptor](src/main/java/org/rostislav/quickdrop/interceptor/FilePasswordInterceptor.java) redirects to `/file/password/{uuid}` when a file has a password and session token is missing.
- **Sessions/tokens**: [SessionService](src/main/java/org/rostislav/quickdrop/service/SessionService.java) keeps admin and file session tokens in-memory; admin tokens are issued after password check in [AdminViewController](src/main/java/org/rostislav/quickdrop/controller/AdminViewController.java), file tokens after passing a file password in [FileViewController](src/main/java/org/rostislav/quickdrop/controller/FileViewController.java).
- **Upload pipeline**: `/api/file/upload-chunk` accepts chunked uploads with metadata `description`, `keepIndefinitely`, `password`, `hidden`, `fileSize`. [AsyncFileMergeService](src/main/java/org/rostislav/quickdrop/service/AsyncFileMergeService.java) buffers chunks in temp, merges via an executor, and streams to disk; if a password is provided and encryption is enabled, it encrypts using [FileEncryptionService](src/main/java/org/rostislav/quickdrop/service/FileEncryptionService.java). Final merge saves via [FileService](src/main/java/org/rostislav/quickdrop/service/FileService.java).
- **File model & storage**: Files are stored on disk under `fileStoragePath` (from settings) using UUID filenames; metadata lives in `file_entity` (includes description, keepIndefinitely, hidden, optional password hash, encrypted flag). Startup ensures `./db` and storage path exist in [QuickdropApplication](src/main/java/org/rostislav/quickdrop/QuickdropApplication.java).
- **Downloads & history**: Standard download `/file/download/{uuid}` decrypts on the fly when needed; uploads/renewals/downloads are all logged (IP + user agent) into unified `file_history_log` with types `UPLOAD`, `RENEWAL`, `DOWNLOAD`. Share links: `/api/file/share/{uuid}` creates token rows with expiry/download count; `/api/file/download/{uuid}/{token}` streams and decrements/removes tokens.
- **Admin surface**: Dashboard shows analytics and file list; settings page edits the single settings row then reschedules cron and refreshes context. Admin actions include toggle hidden, delete, extend life, and keep indefinitely switches, all via [AdminViewController](src/main/java/org/rostislav/quickdrop/controller/AdminViewController.java) and [FileService](src/main/java/org/rostislav/quickdrop/service/FileService.java).
- **Cleanup tasks**: [ScheduleService](src/main/java/org/rostislav/quickdrop/service/ScheduleService.java) schedules file deletion based on settings cron and max life, nightly DB cleanup for missing files, and share token cleanup.
- **Thymeleaf flags**: [GlobalControllerAdvice](src/main/java/org/rostislav/quickdrop/config/GlobalControllerAdvice.java) injects template flags (file list enabled, app password set, admin dashboard button enabled, encryption enabled) used across views and nav.
- **Conventions**: Always mutate file data via `FileService` to ensure logging and encryption decisions. When adding new routes, ensure interceptors are updated appropriately. Respect the single settings row (id=1); creating new rows will break lookups. Chunk uploads return null on intermediate chunksâ€”frontends must handle that.
- **Local dev reminders**: SQLite dialect configured; no migrations beyond Flyway under `src/main/resources/db/migration`. Tests use Spring Boot starter test/JUnit Jupiter but none present; rely on manual runs. Logging writes to `log/quickdrop.log` per properties.