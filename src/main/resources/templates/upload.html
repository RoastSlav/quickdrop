<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload File</title>
</head>
<body>
<h1>Upload a File</h1>
<form enctype="multipart/form-data" id="uploadForm" method="post" th:action="@{/file/upload}">
    <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>
    <div>
        <label for="file">Select a file:</label>
        <input id="file" name="file" required type="file"/>
    </div>
    <div>
        <label for="description">Description:</label>
        <input id="description" name="description" type="text"/>
    </div>
    <div>
        <label for="keepIndefinitely">Keep indefinitely:</label>
        <input id="keepIndefinitely" name="keepIndefinitely" type="checkbox"/>
    </div>
    <div>
        <button type="submit">Upload</button>
    </div>
</form>

<div id="uploadIndicator" style="display: none;">Upload started...</div>
</body>
</html>

<script>
    document.getElementById("uploadForm").addEventListener("submit", function (event) {
        event.preventDefault(); // Prevent the form from submitting synchronously

        // Display the indicator
        document.getElementById("uploadIndicator").style.display = "block";

        // Prepare form data
        const formData = new FormData(event.target);

        // Create an AJAX request
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/file/upload", true);  // Updated to use the new API endpoint

        // Add CSRF token if required
        const csrfTokenElement = document.querySelector('input[name="_csrf"]');
        if (csrfTokenElement) {
            xhr.setRequestHeader("X-CSRF-TOKEN", csrfTokenElement.value);
        }

        // Handle response
        xhr.onload = function () {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.uuid) {
                    // Redirect to the view page using the UUID from the JSON response
                    window.location.href = "/file/" + response.uuid;
                } else {
                    alert("Unexpected response. Please try again.");
                    document.getElementById("uploadIndicator").style.display = "none";
                }
            } else {
                alert("Upload failed. Please try again.");
                document.getElementById("uploadIndicator").style.display = "none";
            }
        };

        // Handle network or server errors
        xhr.onerror = function () {
            alert("An error occurred during the upload. Please try again.");
            document.getElementById("uploadIndicator").style.display = "none";
        };

        // Send the form data
        xhr.send(formData);
    });
</script>
