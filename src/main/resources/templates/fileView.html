<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <title>File View</title>
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="/css/tailwind.css" rel="stylesheet">
    <link href="/css/custom.css" rel="stylesheet">
    <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" rel="stylesheet" integrity="sha512-+JDOg9o9zfxuZgw/Z2c33pX4HTg9CWwcy8v6Tm0tyX/OvGVDyJU1zWDLvq8xPk6E9b3wQAZ50F5Neky3yqd9rw==">
    <link href="/images/favicon.png" rel="icon" type="image/png">
    <script src="/js/tailwindTheme.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script crossorigin="anonymous" defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-xXAJpGJQz/HlPFrrYnYg21DwEI4uGA1gXjZBD2K2F9oWNPspEMO3w3lZaqMw5TRwWtdaeP7aScgD5FRFpEw+Tw=="></script>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-slate-900 dark:text-gray-100">
<nav class="bg-gray-800 dark:bg-gray-900 text-gray-100">
    <div class="max-w-7xl mx-auto px-4 py-4 relative">
        <div class="flex items-center justify-between">
            <a class="flex items-center space-x-2" href="/">
                <img alt="Website Logo" class="h-10" src="/images/favicon.png">
                <span class="font-semibold tracking-tight">QuickDrop</span>
            </a>
            <button aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation"
                    class="md:hidden rounded-lg p-2 hover:bg-sky-600 dark:hover:bg-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500"
                    id="navToggle" type="button">
                <svg aria-hidden="true" class="h-6 w-6" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
                <div class="nav-menu-panel hidden md:flex flex-col md:flex-row md:items-center md:space-x-4 w-full md:w-auto mt-3 md:mt-0 space-y-2 md:space-y-0 bg-gray-800 dark:bg-gray-900 md:bg-transparent md:dark:bg-transparent rounded-lg md:rounded-none p-4 md:p-0 shadow md:shadow-none absolute left-0 right-0 top-full md:static z-20 md:ml-auto" id="navMenu">
                    <div class="flex flex-col space-y-2 md:flex-row md:items-center md:space-x-4 md:space-y-0">
                        <a class="nav-menu-item hover:text-white" href="/file/list" th:if="${isFileListPageEnabled}">View Files</a>
                        <a class="nav-menu-item hover:text-white" href="/file/upload">Upload File</a>
                        <a class="nav-menu-item hover:text-white" href="/admin/dashboard" onclick="requestAdminPassword()"
                           th:if="${isAdminDashboardButtonEnabled}">Admin Dashboard</a>
                    </div>
                    <button class="nav-menu-item theme-toggle rounded-lg p-2 transition-colors hover:bg-sky-600 dark:hover:bg-sky-500 active:scale-95 focus:outline-none focus:ring-2 focus:ring-sky-500"
                            type="button">
                        ðŸŒ™
                    </button>
            </div>
        </div>
    </div>
</nav>
<main class="max-w-7xl mx-auto px-4 py-6 md:py-8">
    <header class="text-center mb-8 space-y-1">
        <h1 class="text-3xl md:text-4xl font-semibold tracking-tight">File View</h1>
    </header>
    <span hidden id="fileUuid" th:text="${file.uuid}"></span>
    <span hidden id="downloadLink" th:text="${downloadLink}"></span>
    <span hidden id="previewUrl" th:text="${previewUrl}"></span>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 items-start">
        <section class="sm:col-span-2">
            <div class="bg-white dark:bg-slate-800 p-6 md:p-8 rounded-2xl shadow-lg flex flex-col gap-4 w-full"
                 id="fileInfoCard">
                <h2 class="text-center text-xl font-semibold tracking-tight" th:text="${file.name}">File Name</h2>
                <p class="text-center text-gray-700 dark:text-gray-300" th:if="${!#strings.isEmpty(file.description)}"
                   th:text="${file.description}"></p>
                <div class="flex justify-between border-t pt-4">
                <span class="font-semibold"
                      th:text="${file.keepIndefinitely} ? 'Uploaded at:' : 'Uploaded/Renewed at:'"></span>
                    <span th:text="${#temporals.format(file.uploadDate, 'dd.MM.yyyy')}"></span>
                </div>
                <small class="text-gray-600 dark:text-gray-400" th:if="${file.keepIndefinitely == false}">Files are kept
                    only for <span th:text="${maxFileLifeTime}">30</span> days after this date.</small>
                <div class="flex justify-between items-center pt-4">
                    <span class="font-semibold">Keep indefinitely:</span>
                    <form method="post" th:action="@{/file/keep-indefinitely/{uuid}(uuid=${file.uuid})}">
                        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden">
                        <input name="keepIndefinitely" type="hidden" value="false">
                        <label class="inline-flex items-center gap-2">
                            <input class="h-4 w-4 rounded border-gray-400 dark:border-gray-600 accent-sky-500 dark:accent-sky-400 focus:ring-sky-500"
                                   id="keepIndefinitely" name="keepIndefinitely"
                                   onchange="updateCheckboxState(event,this)" th:checked="${file.keepIndefinitely}"
                                   th:disabled="${(isKeepIndefinitelyAdminOnly and !hasAdminSession) or (!hasAdminSession and file.passwordHash == null)}" type="checkbox"
                                   value="true">
                        </label>
                    </form>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold">Hide file from list:</span>
                    <form method="post" th:action="@{/file/toggle-hidden/{uuid}(uuid=${file.uuid})}">
                        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden">
                        <input name="hidden" type="hidden" value="false">
                        <label class="inline-flex items-center gap-2">
                            <input class="h-4 w-4 rounded border-gray-400 dark:border-gray-600 accent-sky-500 dark:accent-sky-400 focus:ring-sky-500"
                                   id="hidden" name="hidden" onchange="updateCheckboxState(event,this)"
                                   th:checked="${file.hidden}"
                                   th:disabled="${(isHideFromListAdminOnly and !hasAdminSession) or (!hasAdminSession and file.passwordHash == null)}"
                                   type="checkbox"
                                   value="true">
                        </label>
                    </form>
                </div>
                <div class="flex justify-between items-center border-t pt-4">
                    <span class="font-semibold">File Size:</span>
                    <span th:text="${fileSize}"></span>
                </div>
                <div class="border-t pt-4" th:if="${file.folderUpload}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-semibold">Folder contents</div>
                    </div>
                    <div id="folderTree" class="text-sm font-mono whitespace-pre-wrap bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-100 rounded-lg p-3 max-h-64 overflow-auto folder-tree-box"
                         th:attr="data-manifest=${file.folderManifest},data-folder-name=${file.folderName}"></div>
                    <script id="folderManifestData" type="application/json" th:utext="${file.folderManifest}"></script>
                </div>
                <div class="hidden bg-sky-50 dark:bg-sky-900 text-sky-800 dark:text-sky-300 rounded-lg p-2"
                     id="preparingMessage">Your file is
                    being prepared for download. Please wait...
                </div>
                <div class="mt-4 flex flex-wrap justify-center gap-4 items-center">
                    <a class="rounded-lg bg-sky-500 hover:bg-sky-600 dark:bg-sky-400 dark:hover:bg-sky-500 text-white font-medium px-4 py-2 transition-colors active:scale-95"
                       id="downloadButton"
                       th:href="@{/file/download/{uuid}(uuid=${file.uuid})}"
                       th:onclick="${file.passwordHash != null} ? 'showPreparingMessage()' : ''">Download</a>
                    <form method="post" th:action="@{/file/extend/{uuid}(uuid=${file.uuid})}"
                          th:if="${file.keepIndefinitely == false}">
                        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden">
                        <button class="rounded-lg bg-sky-500 hover:bg-sky-600 dark:bg-sky-400 dark:hover:bg-sky-500 text-white font-medium px-4 py-2 transition-colors active:scale-95"
                                type="submit">
                            Renew File Lifetime
                        </button>
                    </form>
                    <form class="flex gap-2 items-center" method="post"
                          th:action="@{/file/delete/{uuid}(uuid=${file.uuid})}" th:if="${file.passwordHash != null}">
                        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden">
                        <button class="rounded-lg bg-red-600 hover:bg-red-700 text-white font-medium px-4 py-2 transition-colors active:scale-95"
                                id="deleteStartBtn" type="button">
                            Delete File
                        </button>
                        <button class="hidden rounded-lg bg-red-600 hover:bg-red-700 dark:bg-red-600 dark:hover:bg-red-500 text-white font-medium px-4 py-2 transition-all active:scale-95 focus:outline-none focus:ring-2 focus:ring-red-300 dark:focus:ring-red-700 shadow-sm"
                                id="deleteConfirmBtn" type="submit">
                            Confirm
                        </button>
                        <button class="hidden rounded-lg border border-slate-400/70 bg-slate-200 hover:bg-slate-300 dark:border-slate-500 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-900 dark:text-slate-100 font-medium px-4 py-2 transition-all active:scale-95 focus:outline-none focus:ring-2 focus:ring-slate-400 dark:focus:ring-slate-600"
                                id="deleteCancelBtn" type="button">
                            Cancel
                        </button>
                    </form>
                </div>

                 <div class="rounded-xl border border-slate-200 dark:border-slate-700 p-3 bg-slate-50 dark:bg-slate-900" id="previewContainer"
                     th:if="${isPreviewEnabled and (isPreviewableImage or isPreviewableText or isPreviewablePdf)}"
                     th:attr="data-preview-url=${previewUrl},data-preview-image=${isPreviewableImage},data-preview-text=${isPreviewableText},data-preview-pdf=${isPreviewablePdf},data-preview-json=${isPreviewableJson},data-preview-csv=${isPreviewableCsv},data-preview-type=${previewType},data-file-name=${file.name},data-require-manual=${requireManualPreview},data-max-preview-mb=${maxPreviewSizeMB}">
                    <div class="flex items-center justify-between mb-2 text-sm text-gray-600 dark:text-gray-400">
                        <span>Preview</span>
                        <button class="text-xs px-2 py-1 rounded bg-sky-500 text-white hover:bg-sky-600 disabled:opacity-50" type="button"
                                id="loadPreviewBtn" th:if="${requireManualPreview}">
                            Load preview (<span th:text="${maxPreviewSizeMB}">5</span> MB limit)
                        </button>
                    </div>
                    <div id="previewContent" class="flex justify-center">
                        <div class="text-sm text-gray-500" id="previewStatus" th:text="${requireManualPreview} ? 'Click Load preview to fetch.' : 'Loading previewâ€¦'"></div>
                    </div>
                </div>
            </div>
        </section>
        <aside class="sm:col-span-1">
            <div class="bg-white dark:bg-slate-800 p-6 md:p-8 rounded-2xl shadow-lg space-y-4 w-full"
                 id="sharePanel">
                <h2 class="text-xl font-semibold tracking-tight">Share</h2>

                <div class="text-sm text-gray-600 dark:text-gray-400"
                     th:if="${file.passwordHash != null || isAppPasswordSet}">
                    <p>
                        By default, this link requires a password to access the file if the file is password-protected
                        or if the app password is enabled.
                        <br>You can generate an unrestricted link valid for a specific number of days and downloads.
                    </p>
                </div>

                <div class="flex flex-col sm:flex-row gap-2">
                    <input class="w-full min-w-0 flex-1 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2"
                           id="shareLink" readonly
                           type="text">
                    <button class="w-full sm:w-auto shrink-0 rounded-lg bg-sky-500 hover:bg-sky-600 dark:bg-sky-400 dark:hover:bg-sky-500 text-white font-medium px-4 py-2"
                            onclick="copyShareLink()"
                            type="button">
                        Copy
                    </button>
                </div>

                <div class="text-center">
                    <canvas class="mx-auto" height="150" id="shareQRCode" width="150"></canvas>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center gap-2"
                         th:if="${file.passwordHash != null || isAppPasswordSet == true}">
                        <input class="h-4 w-4 rounded border-gray-400 dark:border-gray-600 accent-sky-500 dark:accent-sky-400 focus:ring-sky-500"
                               id="unrestrictedLink" onchange="toggleLinkType()"
                               type="checkbox">
                        <label class="text-sm" for="unrestrictedLink">Generate an unrestricted link</label>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 hidden" id="linkOptions">
                        <div>
                            <label class="block text-sm" for="daysValid">Days valid:</label>
                            <input class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2"
                                   id="daysValid" min="1" type="number"
                                   value="30">
                        </div>
                        <div>
                            <label class="block text-sm" for="allowedNumberOfDownloadsCount">Allowed downloads:</label>
                            <input class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2"
                                   id="allowedNumberOfDownloadsCount" min="1" type="number"
                                   value="1">
                        </div>
                    </div>

                    <div class="flex justify-end items-center gap-2"
                         th:if="${file.passwordHash != null || isAppPasswordSet == true}">
                        <div class="hidden animate-spin rounded-full h-5 w-5 border-2 border-sky-500 border-t-transparent"
                             id="spinner"></div>
                        <button class="hidden rounded-lg bg-sky-500 hover:bg-sky-600 dark:bg-sky-400 dark:hover:bg-sky-500 text-white font-medium px-4 py-2"
                                disabled id="generateLinkButton"
                                onclick="createShareLink()"
                                type="button">
                            Generate
                        </button>
                    </div>
                </div>
            </div>
        </aside>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const navToggle = document.getElementById('navToggle');
        const navMenu = document.getElementById('navMenu');
        if (navToggle && navMenu) {
            const closeMenu = () => {
                navMenu.classList.add('hidden');
                navToggle.setAttribute('aria-expanded', 'false');
            };

            navToggle.addEventListener('click', () => {
                const isHidden = navMenu.classList.contains('hidden');
                navMenu.classList.toggle('hidden');
                navToggle.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
            });

            document.addEventListener('click', (e) => {
                const isMenuClick = navMenu.contains(e.target) || navToggle.contains(e.target);
                if (!isMenuClick && !navMenu.classList.contains('hidden')) {
                    closeMenu();
                }
            });

            navMenu.querySelectorAll('a, button').forEach((el) => {
                el.addEventListener('click', () => closeMenu());
            });
        }
    });
</script>

<script src="/js/fileView.js"></script>
</body>
</html>
