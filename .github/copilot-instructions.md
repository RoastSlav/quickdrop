# QuickDrop AI Working Guide (concise)

- **Build/run**: Java 21. Use `./mvnw clean package` then `java -jar target/quickdrop.jar`. SQLite DB at `db/quickdrop.db`; Flyway auto-runs baseline-on-migrate. Docker image `roastslav/quickdrop:latest` exposes 8080.
- **App shape**: Spring Boot MVC + Thymeleaf. Controllers in [src/main/java/org/rostislav/quickdrop/controller](src/main/java/org/rostislav/quickdrop/controller); services in [service](src/main/java/org/rostislav/quickdrop/service); interceptors in [interceptor](src/main/java/org/rostislav/quickdrop/interceptor); entities/repos in [entity](src/main/java/org/rostislav/quickdrop/entity) and [repository](src/main/java/org/rostislav/quickdrop/repository); static assets + templates under `src/main/resources/static` and `.../templates`.
- **Settings source of truth**: Single-row settings (id=1) via [ApplicationSettingsService](src/main/java/org/rostislav/quickdrop/service/ApplicationSettingsService.java). Startup seeds defaults (max size 1GB, life 30d, storage `files`/`logs`, cron `0 0 2 * * *`, app password off, admin password empty, file list & admin button enabled, encryption on, default home upload) and schedules cleanup. Never create extra rows.
- **Security**: [SecurityConfig](src/main/java/org/rostislav/quickdrop/config/SecurityConfig.java) enables whole-app password mode (`/password/login`), BCrypt auth, CSRF cookie, permissive CORS. Session timeout set in [WebConfig](src/main/java/org/rostislav/quickdrop/config/WebConfig.java). Admin and file tokens stored in-memory in [SessionService](src/main/java/org/rostislav/quickdrop/service/SessionService.java).
- **Interceptors**: [AdminPasswordSetupInterceptor](src/main/java/org/rostislav/quickdrop/interceptor/AdminPasswordSetupInterceptor.java) enforces `/admin/setup` until admin password exists. [AdminPasswordInterceptor](src/main/java/org/rostislav/quickdrop/interceptor/AdminPasswordInterceptor.java) gates `/admin/**` and file history. [FilePasswordInterceptor](src/main/java/org/rostislav/quickdrop/interceptor/FilePasswordInterceptor.java) redirects to `/file/password/{uuid}` when missing a valid file session token.
- **Upload pipeline**: `/api/file/upload-chunk` accepts chunked uploads with metadata (`description`, `keepIndefinitely`, `password`, `hidden`, `fileSize`, folder fields). [AsyncFileMergeService](src/main/java/org/rostislav/quickdrop/service/AsyncFileMergeService.java) buffers/merges chunks; [FileEncryptionService](src/main/java/org/rostislav/quickdrop/service/FileEncryptionService.java) encrypts when password + encryption enabled; final persist via [FileService](src/main/java/org/rostislav/quickdrop/service/FileService.java). Intermediate chunk calls return null—frontends must handle.
- **Storage/model**: Files stored on disk under `fileStoragePath` (from settings) with UUID filenames; metadata in `file_entity` (description, keepIndefinitely, hidden, optional password hash, encrypted flag, folder fields). [QuickdropApplication](src/main/java/org/rostislav/quickdrop/QuickdropApplication.java) ensures `./db` and storage path exist.
- **Downloads & history**: `/file/download/{uuid}` decrypts on the fly; logs uploads/renewals/downloads with IP/UA into `file_history_log` (types `UPLOAD`, `RENEWAL`, `DOWNLOAD`). Share links via `/api/file/share/{uuid}` and `/api/file/download/{uuid}/{token}` decrement/delete tokens.
- **Admin UX**: Dashboard lists files with download counts and actions (view, history, download, delete, keep indefinitely toggle, hidden toggle) plus analytics (total downloads, space, avg size). Public list and admin dashboard now paginated/searchable (page/size/query params) with in-memory caching of page results; cache evicted on uploads, deletions, renewals, hidden/keep toggles, downloads.
- **Cleanup/scheduling**: [ScheduleService](src/main/java/org/rostislav/quickdrop/service/ScheduleService.java) schedules deletions per cron/max life, missing-file cleanup, share token cleanup. App uses @EnableScheduling.
- **Thymeleaf flags**: [GlobalControllerAdvice](src/main/java/org/rostislav/quickdrop/config/GlobalControllerAdvice.java) injects template booleans (file list enabled, app password set, admin button enabled, encryption enabled).
- **Conventions**: Route all file mutations through `FileService` to ensure logging/notifications/encryption. Update interceptors when adding protected routes. Keep single settings row intact. For pagination/search, reuse Page-based service methods and propagate `page/size/query` to templates. Cache keys live in `publicFiles`, `adminFiles`, `analytics` (see [CacheConfig](src/main/java/org/rostislav/quickdrop/config/CacheConfig.java)).
- **Dev tips**: SQLite dialect configured; migrations live under `src/main/resources/db/migration`. Few/no automated tests—manual `./mvnw clean package` is typical. Logs at `log/quickdrop.log` (see properties). Default port 8080.